<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>CRUD Usuários com ApiService</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      padding: 2em;
    }
    table {
      margin-top: 1em;
    }
  </style>
</head>

<body class="container">
  <h1 class="mb-4">Gerenciamento de Livros</h1>

  <div class="mb-3">
    <input type="number" id="txtIdLivro" class="form-control mb-2" disabled placeholder="ID (para update ou delete)" />
    <input type="text" id="txtNomeLivro" class="form-control mb-2" placeholder="Nome Livro" />
    <input type="text" id="txtEditora" class="form-control mb-2" placeholder="Editora" />
    <input type="number" id="txtAnoPublicacao" class="form-control mb-2" placeholder="Ano Publicação" />

    <select id="cboGeneros" class="form-select mb-3">
      <option value="">Selecione um genero</option>
    </select>

    <select id="cboAutores" class="form-select mb-3">
      <option value="">Selecione um autor</option>
    </select>
  </div>

  <div class="mb-3" id="divBotoes"></div>
  <div id="divResposta"></div>
  <div id="divTabela"></div>

  <script type="module">
    import ApiService from './ApiService.js';

    let userData = localStorage.getItem("userData");
    if (userData) {
      userData = JSON.parse(userData);
    } else {
      window.location.href = "Login.html";
    }

    const token = userData.data.token;
    const api = new ApiService(token);

    let API_DATA;

    const txtIdLivro = document.getElementById("txtIdLivro");
    const txtNomeLivro = document.getElementById("txtNomeLivro");
    const txtEditora = document.getElementById("txtEditora");
    const txtAnoPublicacao = document.getElementById("txtAnoPublicacao");
    const cboGeneros = document.getElementById("cboGeneros");
    const cboAutores = document.getElementById("cboAutores");    

    const divBotoes = document.getElementById("divBotoes");
    const divResposta = document.getElementById("divResposta");

    function createButton(text, className) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.className = `btn ${className} m-2`;
      return btn;
    }

    const btnListar = createButton("Listar", "btn-primary");
    btnListar.onclick = async function btnListar_click() {
      listAll();
    };
    divBotoes.appendChild(btnListar);

    const btnCriar = createButton("Criar", "btn-success");
    btnCriar.onclick = async function btnCriar_click() {
      if (txtNomeLivro.value.trim() == "") {
        divResposta.textContent = "Livro inválido";
        divResposta.className = "alert alert-danger";
        return;
      }
      if (cboGeneros.value == -1) {
        divResposta.textContent = "selecione um genero";
        divResposta.className = "alert alert-danger";
        return;
      }
      if (cboAutores.value == -1) {
        divResposta.textContent = "selecione um autor";
        divResposta.className = "alert alert-danger";
        return;
      }

      const objetoCriar = {
        "livro": {
          "nomeLivro": txtNomeLivro.value.trim(),
          "editora": txtEditora.value.trim(),
          "anoPublicacao": txtAnoPublicacao.value.trim(),
          "genero": {
            "idGenero": parseInt(cboGeneros.value)
          },
          "autor": {
            "idAutor": parseInt(cboAutores.value)
          }
        }
      };

      const resposta = await api.post("/livros", objetoCriar);
      if (resposta.success == true) {
        divResposta.textContent = "Criado com sucesso!";
        divResposta.className = "alert alert-success";
        listAll();
      } else {
        divResposta.textContent = resposta.error.message;
        divResposta.className = "alert alert-danger";
      }
    };
    divBotoes.appendChild(btnCriar);

    const btnAtualizar = createButton("Atualizar", "btn-warning");
    btnAtualizar.onclick = async function btnAtualizar_click() {
      const idLivro = txtIdLivro.value.trim();
      if (!idLivro) return alert("Informe o ID."); 

      const livroOriginal = API_DATA.data.livros.find(l => l.idLivro == idLivro);

      const objetoAtualizar = {
        "livro": {
          "idLivro": parseInt(idLivro),
          "nomeLivro": txtNomeLivro.value.trim(),
          "editora": txtEditora.value.trim(),
          "anoPublicacao": txtAnoPublicacao.value.trim(),
          "genero": {
            "idGenero": parseInt(cboGeneros.value)
          },
          "autor": {
            "idAutor": parseInt(cboAutores.value)
          }
        }
      };

      const jsonNovo = JSON.stringify(objetoAtualizar.livro);
      const jsonAntigo = JSON.stringify({
        idLivro: livroOriginal.idLivro,
        nomeLivro: livroOriginal.nomeLivro,
        editora: livroOriginal.editora,
        anoPublicacao: livroOriginal.anoPublicacao,
        genero: { idGenero: livroOriginal.genero.idGenero },
        autor: { idAutor: livroOriginal.autor.idAutor }
      });

      if (jsonNovo === jsonAntigo) {
        divResposta.textContent = "Nenhuma alteração realizada.";
        divResposta.className = "alert alert-warning";
        return;
      }

      console.log("ID livro para atualizar:", idLivro);
      
      const resposta = await api.put("/livros", idLivro, objetoAtualizar);
      if (resposta.success == false) {
        divResposta.textContent = resposta.error.message;
        divResposta.className = "alert alert-danger";
      } else {
        divResposta.textContent = "Atualizado com sucesso!";
        divResposta.className = "alert alert-success";
      }
      listAll();
    };
    divBotoes.appendChild(btnAtualizar);

    const btnExcluir = createButton("Excluir", "btn-danger");
    btnExcluir.onclick = async function btnExcluir_click() {
      const idLivro = txtIdLivro.value.trim();
      if (!idLivro) return alert("Informe o ID."); 
      await api.delete("/livros", idLivro);
      listAll();
    };
    divBotoes.appendChild(btnExcluir);

    async function listAll() {
      API_DATA = await api.get("/livros");
      if (API_DATA.success == true) {
        renderTable(API_DATA);
      } else {
        alert("Token inválido");
        window.location.href = "Login.html";
      }
    }

    function renderTable(dados) {
      const divTabela = document.getElementById("divTabela");
      divTabela.innerHTML = "";

      const table = document.createElement("table");
      table.className = "table table-bordered table-striped";

      const thead = document.createElement("thead");
      thead.className = "table-light";
      const trHead = document.createElement("tr");
      ["idLivro", "Nome Livro", "Editora", "Ano de Publicação", "Autor", "Gênero", "Ações"].forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");

      dados.data.livros.forEach(livro => {
        const tr = document.createElement("tr");

        const tdIdLivro = document.createElement("td");
        tdIdLivro.textContent = livro.idLivro;
        tr.appendChild(tdIdLivro);

        const tdNomeLivro = document.createElement("td");
        tdNomeLivro.textContent = livro.nomeLivro;
        tr.appendChild(tdNomeLivro);

        const tdEditora = document.createElement("td");
        tdEditora.textContent = livro.editora;
        tr.appendChild(tdEditora);

        const tdAnoPublicacao = document.createElement("td");
        tdAnoPublicacao.textContent = livro.anoPublicacao;
        tr.appendChild(tdAnoPublicacao);

        const tdGenero = document.createElement("td");
        tdGenero.textContent = livro.genero.idGenero;
        tr.appendChild(tdGenero);

        const tdAutor = document.createElement("td");
        tdAutor.textContent = livro.autor.idAutor;
        tr.appendChild(tdAutor);

        const tdAcoes = document.createElement("td");

        const btnSel = createButton("Selecionar", "btn-sm btn-info me-1");
        btnSel.onclick = function () {
          const itemLivro = livro;
          if (itemLivro) {
            txtIdLivro.value = itemLivro.idLivro;
            txtNomeLivro.value = itemLivro.nomeLivro;
            txtEditora.value = itemLivro.editora;
            txtAnoPublicacao.value = itemLivro.anoPublicacao;
            cboAutores.value = itemLivro.autor.idAutor;
            cboGeneros.value = itemLivro.genero.idGenero;
            divResposta.textContent = "";
            divResposta.className = "";
          }
        };
        tdAcoes.appendChild(btnSel);

        const btnExc = createButton("Excluir", "btn-sm btn-danger");
        btnExc.onclick = async function () {
          if (confirm(`Confirma excluir o usuário ID ${livro.idLivro}?`)) {
            await api.delete("/livros", livro.idLivro);
            listAll();
            divResposta.textContent = `Usuário ID ${livro.idLivro} excluído com sucesso.`;
            divResposta.className = "alert alert-success";
          }
        };
        tdAcoes.appendChild(btnExc);

        tr.appendChild(tdAcoes);
        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      divTabela.appendChild(table);
    }

    function preencherSelectAutores(dados) {
      const select = document.getElementById("cboAutores");
      select.innerHTML = '<option value="-1">Selecione um autor</option>';
      dados.data.autores.forEach(autor => {
        const option = document.createElement("option");
        option.value = autor.idAutor;
        option.textContent = autor.nomeAutor;
        select.appendChild(option);
      });
    }

    const autores = await api.get("/autores");
    preencherSelectAutores(autores);

    function preencherSelectGeneros(dados) {
      const select = document.getElementById("cboGeneros");
      select.innerHTML = '<option value="-1">Selecione um genero</option>';
      dados.data.generos.forEach(genero => {
        const option = document.createElement("option");
        option.value = genero.idGenero;
        option.textContent = genero.nomeGenero;
        select.appendChild(option);
      });
    }

    const generos = await api.get("/generos");
    preencherSelectGeneros(generos);
    listAll();
  </script>
</body>
</html>
