<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <title>CRUD Generos com ApiService</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Meta tag para responsividade em dispositivos móveis -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap para estilização rápida e responsiva -->
  <style>
    body {
      padding: 2em;
    }

    table {
      margin-top: 1em;
    }
  </style>
</head>

<body class="container">
  <!-- Container Bootstrap para centralizar e limitar largura -->

  <h1 class="mb-4">Gerenciamento de Generos</h1>
  <!-- Título principal da aplicação -->

  <!-- Formulário para entrada de dados do usuário -->
  <div class="mb-3">
    <!-- Campo ID (somente leitura, usado para update e delete) -->
    <input type="number" id="txtIdGenero" class="form-control mb-2" disabled placeholder="ID (para update ou delete)" />
    <!-- Campo para nome do usuário -->
    <input type="text" id="txtNomeGenero" class="form-control mb-2" placeholder="Genero" />

  </div>

  <!-- Div onde os botões CRUD serão criados dinamicamente -->
  <div class="mb-3" id="divBotoes"></div>
  <!-- Div para mensagens de resposta/erro -->
  <div id="divResposta"></div>
  <!-- Div onde a tabela de usuários será renderizada -->
  <div id="divTabela"></div>

  <script type="module">
    // Importa a classe ApiService para comunicação com a API (abstrai fetch/axios)
    import ApiService from './ApiService.js';

    //recuperar token do localstorage
    const divUsuario = document.getElementById("divUsuario");
    let userData = localStorage.getItem("userData");

    if (userData) {
      userData = JSON.parse(userData);
    } else {
      window.location.href = "Login.html";
    }

    const token = userData.data.token;
    console.log(token);
    // Instancia o serviço com token opcional (pode ser vazio)
    const api = new ApiService(token);

    // Variável global que armazenará os dados da API para manipulação local
    let API_DATA;

    // Referências para elementos do formulário e divs
    const txtId = document.getElementById("txtIdGenero");
    const txtNomeCargo = document.getElementById("txtNomeGenero");
 
    const divBotoes = document.getElementById("divBotoes");
    const divResposta = document.getElementById("divResposta");

    /**
     * Função para criar um botão HTML com texto e classes CSS,
     * retorna o elemento criado para ser manipulado.
     * @param {string} text - Texto do botão.
     * @param {string} className - Classes CSS para estilizar o botão.
     * @returns {HTMLButtonElement} - Botão criado.
     */
    function createButton(text, className) {
      const btn = document.createElement("button");
      btn.textContent = text;
      btn.className = `btn ${className} me-2 mb-2`; // Margem para espaçamento
      return btn;
    }

    // Criação dos botões principais dinamicamente, com eventos .onclick

    // Botão Listar: atualiza a lista de usuários na tabela
    const btnListar = createButton("Listar", "btn-primary");
    btnListar.onclick = async function btnListar_click() {
      // Chama a função que carrega e exibe todos usuários
      listAll();
    };
    divBotoes.appendChild(btnListar);

    // Botão Criar: adiciona um novo usuário com os dados do formulário
    const btnCriar = createButton("Criar", "btn-success");
    btnCriar.onclick = async function btnCriar_click() {
      // Validação simples para campo nome obrigatório
      if (txtNomeGenero.value.trim() == "") {
        divResposta.textContent = "Gênero inválido";
        divResposta.className = "alert alert-danger";
        return;
      }
      // Monta o objeto a ser enviado na requisição POST
       const objetoCriar = {
        "genero": {
          "nomeGenero": txtNomeGenero.value.trim()
        }
      };

      // Chama a API para criar novo usuário
      await api.post("/generos", objetoCriar);
      // Atualiza a lista após criar
      listAll();
    };
    divBotoes.appendChild(btnCriar);

    // Botão Atualizar: modifica usuário existente pelo ID informado
    const btnAtualizar = createButton("Atualizar", "btn-warning");
    btnAtualizar.onclick = async function btnAtualizar_click() {
      const idGenero = txtIdGenero.value.trim();
      if (!idGenero) return alert("Informe o ID."); // ID obrigatório para atualizar
      const objetoAtualizar = {
        "genero": {
          "nomeGenero": txtNomeGenero.value.trim()
        }
      };
      // Chama API para atualizar usuário pelo ID
      await api.put("/generos", idGenero, objetoAtualizar);
      // Atualiza a lista após alteração
      listAll();
    };
    divBotoes.appendChild(btnAtualizar);

    // Botão Excluir: remove usuário pelo ID informado
    const btnExcluir = createButton("Excluir", "btn-danger");
    btnExcluir.onclick = async function btnExcluir_click() {
      const idGenero = txtIdGenero.value.trim();
      if (!idGenero) return alert("Informe o ID."); // ID obrigatório para exclusão
      await api.delete("/generos", idGenero);
      // Atualiza a lista após exclusão
      listAll();
    };
    divBotoes.appendChild(btnExcluir);

    /**
     * Função para listar todos usuários: busca dados da API e chama renderização da tabela.
     */
    async function listAll() {
      API_DATA = await api.get("/generos"); // Busca todos os usuários via GET

      //verifica se a solicição para a api retorna true
      if (API_DATA.success == true) {
        renderTable(API_DATA); // Renderiza tabela com os dados retornados
      } else {
        alert("Token inválido");
        window.location.href = "Login.html";
      }
    }

    /**
     * Função para renderizar a tabela HTML dinamicamente com os dados recebidos.
     * @param {Array} dados - Array de objetos usuários para exibir.
     */
    function renderTable(dados) {
      const divTabela = document.getElementById("divTabela");
      divTabela.innerHTML = ""; // Limpa tabela antiga

      // Cria tabela e estiliza com classes Bootstrap
      const table = document.createElement("table");
      table.className = "table table-bordered table-striped";

      // Cria cabeçalho da tabela
      const thead = document.createElement("thead");
      thead.className = "table-light";
      const trHead = document.createElement("tr");
      ["ID Gênero", "Nome Genero", "Ações"].forEach(text => {
        const th = document.createElement("th");
        th.textContent = text;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);
      table.appendChild(thead);

      // Cria corpo da tabela (tbody)
      const tbody = document.createElement("tbody");

      // Para cada usuário, cria uma linha na tabela
      dados.data.generos.forEach(genero => {
        const tr = document.createElement("tr");

        // Coluna ID
        const tdIdGenero = document.createElement("td");
        tdIdGenero.textContent = genero.idGenero;
        tr.appendChild(tdIdGenero);

        // Coluna Nome
        const tdNomeGenero = document.createElement("td");
        tdNomeGenero.textContent = genero.nomeGenero;
        tr.appendChild(tdNomeGenero);


        // Coluna Ações: botões Selecionar e Excluir
        const tdAcoes = document.createElement("td");

        // Botão Selecionar: preenche o formulário com os dados do usuário clicado
        const btnSel = createButton("Selecionar", "btn-sm btn-info me-1");
        btnSel.onclick = function () {
          // Busca o item na lista global pelo ID
          const itemGenero = genero;
          if (itemGenero) {
            txtIdGenero.value = itemGenero.idGenero;       // Preenche campo ID (desabilitado)
            txtNomeCargo.value = itemGenero.nomeGenero;   // Preenche campo Nome

            divResposta.textContent = "";            // Limpa mensagens anteriores
            divResposta.className = "";
          }
        };
        tdAcoes.appendChild(btnSel);

        // Botão Excluir: pergunta confirmação e exclui o usuário da API
        const btnExc = createButton("Excluir", "btn-sm btn-danger");
        btnExc.onclick = async function () {
          if (confirm(`Confirma excluir o usuário ID ${genero.idGenero}?`)) {
            await api.delete("/generos", genero.idGenero); // Exclui pela API
            listAll();                          // Atualiza lista após exclusão
            divResposta.textContent = `Usuário ID ${genero.idGenero} excluído com sucesso.`;
            divResposta.className = "alert alert-success";
          }
        };
        tdAcoes.appendChild(btnExc);

        tr.appendChild(tdAcoes);
        tbody.appendChild(tr);
      });

      // Anexa o corpo à tabela e insere na div da tabela
      table.appendChild(tbody);
      divTabela.appendChild(table);
    }

    // Inicializa a listagem ao carregar a página
    listAll();

  </script>

  <!-- 
  ===========================
  NOTAS DE AULA:
  ===========================

  - Este código implementa um CRUD básico de usuários consumindo uma API via a classe ApiService,
    que abstrai requisições HTTP (GET, POST, PUT, DELETE).

  - Os botões são criados dinamicamente e recebem eventos via .onclick,
    que chamam funções assíncronas para comunicação com a API.

  - O formulário possui campos para ID (desabilitado), nome e email do usuário.
    O ID é preenchido ao selecionar um usuário da tabela.

  - A tabela é renderizada dinamicamente a partir dos dados obtidos da API,
    com botões para selecionar um usuário e preencher o formulário,
    e para excluir diretamente da tabela.

  - A função listAll() centraliza a lógica para carregar e renderizar os dados,
    sendo chamada após cada operação que altera os dados.

  - Mensagens de erro e sucesso são exibidas na divResposta para feedback do usuário.

  - Uso do Bootstrap para estilização rápida e responsiva, facilitando o layout.

  - A API é simulada aqui com "usuarios.json" para facilitar testes locais,
    mas em ambiente real seria o endpoint RESTful da aplicação backend.

  - Atenção para closures nas funções onclick que capturam corretamente o id do usuário
    para evitar erros comuns em loops e callbacks.

  - Boa prática usar async/await para manipular requisições assíncronas,
    tornando o código mais legível e sequencial.

  - O campo ID é desabilitado para evitar edição manual, pois o backend é responsável
    por gerar e gerenciar os IDs dos usuários.

  - Pode-se melhorar o código implementando validações mais robustas e tratamento de erros mais detalhado.
  -->
</body>

</html>